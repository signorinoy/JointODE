% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/utils.R
\name{.solve_joint_ode}
\alias{.solve_joint_ode}
\title{Solve Joint ODE System}
\usage{
.solve_joint_ode(params, initial = c(0, 0, 0))
}
\arguments{
\item{params}{A list containing all necessary model components:
\describe{
\item{data}{Subject-specific data with components:
\itemize{
\item \code{time}: Event/censoring time
\item \code{status}: Event indicator (0/1)
\item \code{covariates}: Baseline covariates for survival model
\item \code{longitudinal}: List with times, measurements, covariates
}
}
\item{coef}{Model coefficients:
\itemize{
\item \code{baseline}: B-spline coefficients for baseline hazard
\item \code{hazard}: Coefficients
\eqn{[\alpha_m, \alpha_{\dot{m}}, \alpha_{\ddot{m}},}
\eqn{\phi_1, ..., \phi_p]}
\item \code{index_g}: B-spline coefficients for g(u) function
\item \code{index_beta}: Single index coefficients
\eqn{[\beta_m, \beta_{\dot{m}}, \beta_X, \beta_t]}
}
}
\item{config}{Spline configurations:
\itemize{
\item \code{baseline}: Config for baseline hazard B-splines
\item \code{index}: Config for single index model B-splines
}
}
}}

\item{initial}{Initial conditions \eqn{[\Lambda(0), m(0), \dot{m}(0)]}.
Default is c(0, 0, 0).}
}
\value{
A list containing the ODE solution with components:
\describe{
\item{cum_hazard}{Cumulative hazard \eqn{\Lambda(T)} at event time
(without exp(b))}
\item{log_hazard}{Log-hazard \eqn{\log(\lambda(T))} at event time
(WITHOUT b term)}
\item{biomarker}{Vector of biomarker values \eqn{m(t)} at observation
times (WITHOUT b shift). NULL if no longitudinal observations
exist.}
}
}
\description{
Solves the ODE system governing biomarker trajectories and cumulative hazard
in joint models. Computes dynamics without random effects for efficiency,
which are added post-computation.
}
\details{
The ODE system is:
\deqn{
  \frac{d}{dt}\begin{pmatrix}\Lambda \\ m \\ \dot{m}\end{pmatrix} =
  \begin{pmatrix}
    \lambda(t) \\
    \dot{m} \\
    g(\beta^T Z)
  \end{pmatrix}
}

where:
\itemize{
\item \eqn{\Lambda(t)} is the cumulative hazard function
\item \eqn{m(t)} is the biomarker trajectory
\item \eqn{\dot{m}(t)} is the biomarker velocity (first derivative)
\item \eqn{\lambda(t) = \exp[\eta^T B_\lambda(t) + \alpha_m m(t) +}
\eqn{\alpha_{\dot{m}} \dot{m}(t) + \alpha_{\ddot{m}} \ddot{m}(t) +}
\eqn{W^T\phi]}
is the hazard function
\item \eqn{g(u) = \theta^T B_g(u)} is the flexible acceleration function
\item \eqn{u = \beta^T Z} is the single index with
\eqn{Z = [m, \dot{m}, X_{long}, t]}
\item \eqn{B_\lambda(t)} and \eqn{B_g(u)} are B-spline basis functions
}

The random effect \eqn{b_i} represents subject-specific deviation and is
excluded from the ODE for computational efficiency. To incorporate \eqn{b_i}:
\itemize{
\item Actual log-hazard: \code{log_hazard + b}
\item Actual cumulative hazard: \code{Lambda * exp(b)}
\item Actual biomarker for likelihood: \code{biomarker + b}
}

This separation is mathematically valid because \eqn{b_i} enters as an
additive constant in the log-hazard, yielding:
\eqn{\Lambda(t|b) = e^b \Lambda(t|0)}.
The ODE solver uses adaptive step size control (LSODA method) for
numerical stability.
}
\examples{
\dontrun{
# Example: Solve ODE for a subject
params <- list(
  data = subject_data,  # Subject-specific data
  coef = list(
    baseline = c(0.1, 0.2, 0.15),     # Baseline hazard spline coefficients
    hazard = c(0.3, 0.1, 0.05, 0.2),  # Hazard coefficients
    index_g = c(0.5, 0.3, 0.2),       # Acceleration function coefficients
    index_beta = c(0.4, 0.2, 0.1, 0.15) # Single index coefficients
  ),
  config = list(
    baseline = baseline_spline_config,
    index = index_spline_config
  )
)

# Solve the ODE system
sol <- .solve_joint_ode(params)

# Incorporate random effect b_i = 0.5
b <- 0.5
actual_log_hazard <- sol$log_hazard + b
actual_cum_hazard <- sol$cum_hazard * exp(b)
predicted_biomarker <- sol$biomarker + b  # Add b to biomarker values
}

}
\seealso{
\code{\link{JointODE}} for the main model fitting function
}
\concept{utilities}
